# Test Realtime Updates: Device 358657105966092

## ðŸŽ¯ Test Device
**Device ID:** `358657105966092`  
**Status:** âœ… Active on GPS51 platform (receiving updates)

---

## ðŸ“Š Step 1: Check Current Device Status

### Run in Supabase SQL Editor:

```sql
-- Check current position and last update time
SELECT 
  device_id,
  latitude,
  longitude,
  speed,
  heading,
  battery_percent,
  ignition_on,
  is_online,
  gps_time,
  cached_at,
  NOW() - cached_at as time_since_update
FROM vehicle_positions
WHERE device_id = '358657105966092';
```

**Expected:** Should return current position data

---

## ðŸ§ª Step 2: Browser Testing

### 1. Navigate to Vehicle Profile:
```
http://localhost:5173/owner/vehicle/358657105966092
```

### 2. Open Browser Console (F12 â†’ Console tab)

### 3. Look for Subscription Messages:
You should see:
```
[Realtime] ðŸ”µ Setting up subscription for device: 358657105966092
[Realtime] ðŸ“¡ Subscription status for 358657105966092: SUBSCRIBED
[Realtime] âœ… Successfully subscribed to vehicle_positions updates for 358657105966092
[Realtime] ðŸŽ¯ Waiting for position updates...
```

### 4. Check Network Tab:
- DevTools â†’ Network â†’ Filter "WS" (WebSocket)
- Should see WebSocket connection to Supabase Realtime
- Status: "101 Switching Protocols"

### 5. Monitor for Updates:
Since this device is actively updating on GPS51, you should see updates automatically when:
- GPS sync cron job runs (every ~60 seconds)
- Vehicle moves and sends new GPS data

**Watch console for:**
```
[Realtime] Position update received for 358657105966092: { event: 'UPDATE', ... }
[Realtime] Mapped data: { deviceId: '358657105966092', latitude: ..., longitude: ... }
[Realtime] âœ… Cache updated and invalidated for 358657105966092
```

### 6. Verify UI Updates:
- âœ… Map marker moves when vehicle position changes
- âœ… Coordinates display updates
- âœ… "Last updated" timestamp refreshes
- âœ… Speed/heading updates (if vehicle is moving)
- âœ… No page refresh required

---

## âš¡ Step 3: Trigger Immediate Update (Optional)

If you want to test immediately without waiting for GPS sync:

```sql
-- Manually trigger an update to test realtime
UPDATE vehicle_positions 
SET 
  latitude = latitude + 0.0001,
  longitude = longitude + 0.0001,
  cached_at = NOW()
WHERE device_id = '358657105966092';
```

**Expected:** Map marker should move instantly (< 1 second)

---

## ðŸ“ˆ Step 4: Monitor Recent Updates

### Check update frequency:

```sql
-- See recent updates for this device
SELECT 
  device_id,
  latitude,
  longitude,
  speed,
  cached_at,
  NOW() - cached_at as age
FROM vehicle_positions
WHERE device_id = '358657105966092'
ORDER BY cached_at DESC
LIMIT 5;
```

### Monitor realtime subscription activity:

Keep browser console open and watch for:
- Subscription status changes
- Position update messages
- Cache invalidation confirmations

---

## âœ… Success Criteria

- [x] Database: Configuration verified âœ…
- [ ] Browser: Console shows successful subscription
- [ ] Browser: WebSocket connection active
- [ ] Browser: Position updates received automatically (from GPS51)
- [ ] Browser: Map marker updates instantly (< 1 second)
- [ ] Browser: No page refresh required
- [ ] Browser: Updates continue as GPS51 sends new data

---

## ðŸŽ¯ Expected Behavior

### With Realtime Working:
1. **Initial Load:** Page loads with current position
2. **Subscription:** Console shows "Successfully subscribed"
3. **Automatic Updates:** When GPS51 sends new data â†’ GPS sync updates DB â†’ Realtime pushes to browser â†’ Map updates instantly
4. **No Polling:** No need to refresh page or wait for polling interval

### Update Flow:
```
GPS51 Platform â†’ GPS Sync Cron â†’ vehicle_positions DB â†’ Realtime â†’ Browser â†’ Map Updates
```

**Timeline:** GPS51 update â†’ DB update â†’ Browser update = < 1 second

---

## ðŸ› Troubleshooting

### Issue: No updates received after 2+ minutes
**Check:**
- Is GPS sync cron job running? (Check Supabase Edge Functions logs)
- Is device actually sending updates to GPS51?
- Check console for any error messages

### Issue: Subscription fails
**Check:**
- Console for "CHANNEL_ERROR" message
- Network tab for WebSocket connection errors
- Verify RLS policies allow SELECT on vehicle_positions

### Issue: Map doesn't update
**Check:**
- Console shows "Position update received"?
- React DevTools â†’ Check component re-renders
- Verify no JavaScript errors in console

---

## ðŸ“ Test Results

```
Device ID: 358657105966092
Test Date: ___________

Database Status:
[x] Device exists in vehicle_positions âœ…
[x] Recent updates visible âœ…

Browser Test:
[ ] Subscription successful
[ ] WebSocket connected
[ ] Updates received automatically
[ ] Map updates instantly
[ ] No refresh needed

Update Frequency Observed:
- GPS sync interval: _____ seconds
- Realtime latency: _____ seconds (should be < 1)

Status: âœ… PASS / âŒ FAIL
```

---

## ðŸš€ Quick Test Commands

### Check device exists:
```sql
SELECT device_id, latitude, longitude, cached_at 
FROM vehicle_positions 
WHERE device_id = '358657105966092';
```

### Force immediate update:
```sql
UPDATE vehicle_positions 
SET latitude = latitude + 0.0001, cached_at = NOW()
WHERE device_id = '358657105966092';
```

### Monitor updates:
```sql
SELECT cached_at, latitude, longitude, speed
FROM vehicle_positions
WHERE device_id = '358657105966092'
ORDER BY cached_at DESC;
```

---

**Ready to test! Navigate to the vehicle profile page and monitor the console for realtime updates.** ðŸŽ¯
